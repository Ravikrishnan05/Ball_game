<!DOCTYPE html>
<html>
<head>
  <title>Compass Controller</title>
  <style>
    body {
      background: black;
      text-align: center;
      color: white;
      font-family: Arial;
    }
    canvas {
      background: #111;
      display: block;
      margin: 20px auto;
      border: 2px solid #333;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #data {
      color: #0FF;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>Compass Controller</h1>
  <button id="connectBtn">CONNECT BLUETOOTH</button>
  <canvas id="gameCanvas" width="400" height="400"></canvas>
  <div id="data">Waiting for data...</div>

  <script>
    // Canvas setup
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const dataDisplay = document.getElementById('data');

    // Player dot
    const dot = {
      x: 200,
      y: 200,
      size: 15,
      color: '#FFFF00'
    };

    // Draw the dot
    function drawDot() {
      ctx.fillStyle = dot.color;
      ctx.beginPath();
      ctx.arc(dot.x, dot.y, dot.size, 0, Math.PI * 2);
      ctx.fill();
    }

    // Clear and redraw
    function update() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawDot();
      requestAnimationFrame(update);
    }

    // Bluetooth connection
    async function connectBluetooth() {
      try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        const reader = port.readable.getReader();
        
        dataDisplay.textContent = "Connected! Tilt your Arduino...";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          
          const text = new TextDecoder().decode(value).trim();
          
          // Parse the exact format your Arduino sends: "X,Y"
          if (text.includes(',')) {
            const [xStr, yStr] = text.split(',');
            const x = parseInt(xStr);
            const y = parseInt(yStr.split(' ')[0]); // Handle any extra text
            
            if (!isNaN(x) && !isNaN(y)) {
              // Map compass values (-2000 to 2000) to screen position
              dot.x = Math.max(dot.size, Math.min(canvas.width - dot.size, 
                mapValue(x, -2000, 2000, 0, canvas.width));
              dot.y = Math.max(dot.size, Math.min(canvas.height - dot.size, 
                mapValue(y, -2000, 2000, 0, canvas.height));
              
              dataDisplay.textContent = `X: ${x}, Y: ${y}`;
            }
          }
        }
      } catch (err) {
        dataDisplay.textContent = `Error: ${err.message}`;
      }
    }

    // Helper to map value ranges
    function mapValue(value, inMin, inMax, outMin, outMax) {
      return (value - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
    }

    // Event listener
    document.getElementById('connectBtn').addEventListener('click', connectBluetooth);

    // Start animation
    update();
  </script>
</body>
</html>
