<!DOCTYPE html>
<html>
<head>
  <title>Simple Bluetooth Controller</title>
  <style>
    body {
      background: black;
      text-align: center;
      color: white;
      font-family: Arial;
    }
    canvas {
      background: #111;
      display: block;
      margin: 20px auto;
      border: 2px solid #333;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #status {
      color: #FF0;
      height: 20px;
    }
  </style>
</head>
<body>
  <h1>Bluetooth Controller Test</h1>
  <div id="status">Press CONNECT to start</div>
  <button id="connectBtn">CONNECT</button>
  <canvas id="gameCanvas" width="400" height="400"></canvas>
  <div id="data">Waiting for data...</div>

  <script>
    // Canvas setup
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const statusDisplay = document.getElementById('status');
    const dataDisplay = document.getElementById('data');

    // Player dot
    const player = {
      x: 200,
      y: 200,
      size: 20,
      color: '#FFFF00'
    };

    // Draw player
    function drawPlayer() {
      ctx.fillStyle = player.color;
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
      ctx.fill();
    }

    // Clear and redraw
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawPlayer();
    }

    // Bluetooth connection
    async function connectBluetooth() {
      try {
        if (!navigator.serial) {
          throw new Error("Browser doesn't support Web Serial API");
        }
        
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        const reader = port.readable.getReader();
        
        statusDisplay.textContent = "Connected! Tilt your Arduino";
        dataDisplay.textContent = "Receiving data...";

        // Continuous data reading
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          
          const text = new TextDecoder().decode(value).trim();
          dataDisplay.textContent = `Raw Data: ${text}`;
          
          // Simple X,Y data parsing (format "X,Y")
          const [x, y] = text.split(',').map(Number);
          
          if (!isNaN(x) && !isNaN(y)) {
            // Map Arduino values to screen position
            player.x = mapValue(x, -1000, 1000, 0, canvas.width);
            player.y = mapValue(y, -1000, 1000, 0, canvas.height);
            
            // Keep player on screen
            player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
            player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
            
            draw();
          }
        }
      } catch (err) {
        statusDisplay.textContent = `Error: ${err.message}`;
      }
    }

    // Helper function to map values
    function mapValue(value, inMin, inMax, outMin, outMax) {
      return (value - inMin) * (outMax - outMin) / (inMax - inMin) + outMin;
    }

    // Event listener
    document.getElementById('connectBtn').addEventListener('click', connectBluetooth);

    // Initial draw
    draw();
  </script>
</body>
</html>
